name: Release FerretDB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'FerretDB version'
        required: true
        type: choice
        options:
          - 2.7.0
        default: 2.7.0
      platforms:
        description: 'Platforms'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'linux-x64'
          - 'linux-arm64'
          - 'darwin-x64'
          - 'darwin-arm64'
          - 'win32-x64'

# Prevent concurrent runs that could conflict when updating releases.json
concurrency:
  group: release-ferretdb
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version against databases.json
        run: |
          DB="ferretdb"

          echo "Validating FerretDB version: $VERSION"

          # Check if version exists and is enabled in databases.json
          ENABLED=$(jq -r ".databases.$DB.versions[\"$VERSION\"] // false" databases.json)
          if [ "$ENABLED" != "true" ]; then
            echo "::error::Version '$VERSION' is not enabled in databases.json"
            echo ""
            echo "Available versions:"
            jq -r ".databases.$DB.versions | to_entries | map(select(.value == true)) | .[].key" databases.json
            exit 1
          fi

          echo "✓ Version $VERSION is enabled in databases.json"

      - name: Validate sources.json exists
        run: |
          DB="ferretdb"
          if [ ! -f "builds/$DB/sources.json" ]; then
            echo "::error::Missing builds/$DB/sources.json"
            exit 1
          fi
          echo "✓ builds/$DB/sources.json exists"

      - name: Validate version in sources.json
        run: |
          DB="ferretdb"

          HAS_VERSION=$(jq -r ".versions[\"$VERSION\"] // empty" "builds/$DB/sources.json")
          if [ -z "$HAS_VERSION" ]; then
            echo "::error::Version '$VERSION' not found in builds/$DB/sources.json"
            echo ""
            echo "Available versions in sources.json:"
            jq -r ".versions | keys[]" "builds/$DB/sources.json"
            exit 1
          fi

          echo "✓ Version $VERSION found in sources.json"

  build:
    needs: validate
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
      PLATFORMS: ${{ github.event.inputs.platforms }}
    outputs:
      artifact_names: ${{ steps.build.outputs.artifact_names }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Verify Go installation
        run: go version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download and build FerretDB
        id: build
        run: |
          if [ "$PLATFORMS" = "all" ]; then
            pnpm download:ferretdb -- --version "$VERSION" --all-platforms --output ./dist
          else
            pnpm download:ferretdb -- --version "$VERSION" --platform "$PLATFORMS" --output ./dist
          fi

          # List created artifacts
          ls -la ./dist/

          # Create artifact names output (handle case where no files exist)
          shopt -s nullglob
          FILES=(./dist/*.tar.gz ./dist/*.zip)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "ERROR: No artifacts were created"
            exit 1
          fi
          ARTIFACTS=$(printf '%s\n' "${FILES[@]}" | xargs -n1 basename | tr '\n' ',' | sed 's/,$//')
          echo "artifact_names=$ARTIFACTS" >> $GITHUB_OUTPUT

      - name: Generate checksums
        run: |
          shopt -s nullglob
          cd dist
          for f in *.tar.gz *.zip; do
            if [ -f "$f" ]; then
              sha256sum "$f" >> checksums.txt
            fi
          done
          cat checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ferretdb-${{ github.event.inputs.version }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ferretdb-${{ github.event.inputs.version }}
          path: ./release-assets

      - name: List release assets
        run: ls -la ./release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ferretdb-${{ github.event.inputs.version }}
          name: FerretDB ${{ github.event.inputs.version }}
          body: |
            ## FerretDB ${{ github.event.inputs.version }}

            Open-source MongoDB alternative using PostgreSQL as the backend.

            ### License

            Apache-2.0 - Fully permissive for commercial use.

            ### Bundled Components

            - **FerretDB** - MongoDB wire protocol proxy
            - **mongosh** - MongoDB Shell
            - **database-tools** - mongodump, mongorestore, etc.

            ### Platforms
            - `linux-x64` - Linux x86_64 (Ubuntu 22.04+)
            - `linux-arm64` - Linux ARM64 (Ubuntu 22.04+)
            - `darwin-x64` - macOS x86_64
            - `darwin-arm64` - macOS Apple Silicon
            - `win32-x64` - Windows x64

            ### Usage
            ```bash
            # Download URL pattern
            https://github.com/${{ github.repository }}/releases/download/ferretdb-${{ github.event.inputs.version }}/ferretdb-${{ github.event.inputs.version }}-<platform>.tar.gz
            ```

            ### Checksums
            See `checksums.txt` for SHA256 checksums.

            ### Source
            - FerretDB: [GitHub Releases](https://github.com/FerretDB/FerretDB/releases)
            - mongosh: [MongoDB Downloads](https://www.mongodb.com/try/download/shell)
            - database-tools: [MongoDB Downloads](https://www.mongodb.com/try/download/database-tools)
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
            release-assets/checksums.txt
          fail_on_unmatched_files: false

  update-manifest:
    needs: release
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update releases.json
        run: |
          pnpm tsx scripts/update-releases.ts \
            --database ferretdb \
            --version "$VERSION" \
            --tag "ferretdb-$VERSION"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "chore: update releases.json for ferretdb-$VERSION"

          # Retry push with rebase if remote has changed
          for i in 1 2 3; do
            if git push; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed, attempting rebase (attempt $i/3)..."
            git fetch origin main
            if ! git rebase origin/main; then
              echo "ERROR: Rebase failed due to conflicts. Manual intervention required."
              git rebase --abort
              exit 1
            fi
            sleep $((2**i))
          done
          echo "ERROR: Push failed after 3 attempts"
          exit 1

  # Trigger sync to ensure releases.json is fully up to date
  trigger-sync:
    needs: update-manifest
    runs-on: ubuntu-latest
    steps:
      - name: Trigger sync-releases workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run sync-releases.yml --repo ${{ github.repository }}
          echo "Triggered sync-releases workflow"
