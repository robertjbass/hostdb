name: Release MariaDB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'MariaDB version'
        required: true
        type: choice
        options:
          - 11.8.5
          - 11.4.5
          - 10.11.15
        default: 11.8.5
      platforms:
        description: 'Platforms to build'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'linux-x64'
          - 'linux-arm64'
          - 'darwin-x64'
          - 'darwin-arm64'
          - 'win32-x64'

# Prevent concurrent runs that could conflict when updating releases.json
concurrency:
  group: release-mariadb
  cancel-in-progress: false

jobs:
  # Validate version against databases.json
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version against databases.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DB="mariadb"

          echo "Validating MariaDB version: $VERSION"

          # Check if version exists and is enabled in databases.json
          ENABLED=$(jq -r ".databases.$DB.versions[\"$VERSION\"] // false" databases.json)
          if [ "$ENABLED" != "true" ]; then
            echo "::error::Version '$VERSION' is not enabled in databases.json"
            echo ""
            echo "Available versions:"
            jq -r ".databases.$DB.versions | to_entries | map(select(.value == true)) | .[].key" databases.json
            exit 1
          fi

          echo "✓ Version $VERSION is enabled in databases.json"

      - name: Validate sources.json exists
        run: |
          DB="mariadb"
          if [ ! -f "builds/$DB/sources.json" ]; then
            echo "::error::Missing builds/$DB/sources.json"
            exit 1
          fi
          echo "✓ builds/$DB/sources.json exists"

      - name: Validate version in sources.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DB="mariadb"

          HAS_VERSION=$(jq -r ".versions[\"$VERSION\"] // empty" "builds/$DB/sources.json")
          if [ -z "$HAS_VERSION" ]; then
            echo "::error::Version '$VERSION' not found in builds/$DB/sources.json"
            echo ""
            echo "Available versions in sources.json:"
            jq -r ".versions | keys[]" "builds/$DB/sources.json"
            exit 1
          fi

          echo "✓ Version $VERSION found in sources.json"

  # Determine which platforms to build based on input
  prepare:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          if [ "$PLATFORMS" = "all" ]; then
            # All 5 platforms with their appropriate runners
            MATRIX='[
              {"platform": "linux-x64", "runner": "ubuntu-latest", "build_type": "docker"},
              {"platform": "linux-arm64", "runner": "ubuntu-latest", "build_type": "docker"},
              {"platform": "darwin-x64", "runner": "macos-15-intel", "build_type": "native"},
              {"platform": "darwin-arm64", "runner": "macos-14", "build_type": "native"},
              {"platform": "win32-x64", "runner": "ubuntu-latest", "build_type": "download"}
            ]'
          else
            # Single platform - determine runner and build type
            case "$PLATFORMS" in
              linux-x64|linux-arm64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"ubuntu-latest\", \"build_type\": \"docker\"}]"
                ;;
              darwin-x64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"macos-15-intel\", \"build_type\": \"native\"}]"
                ;;
              darwin-arm64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"macos-14\", \"build_type\": \"native\"}]"
                ;;
              win32-x64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"ubuntu-latest\", \"build_type\": \"download\"}]"
                ;;
            esac
          fi
          # Compact the JSON for output
          MATRIX=$(echo "$MATRIX" | jq -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Building platforms: $MATRIX"

  # Build each platform in parallel
  build:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Set up QEMU for cross-platform Docker builds (required for linux-arm64 on x64 runners)
      - name: Set up QEMU
        if: matrix.build_type == 'docker'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: matrix.build_type == 'docker'
        uses: docker/setup-buildx-action@v3

      # For Linux: use Docker-based builds (download or source build)
      - name: Build for Linux/Windows (download or Docker)
        if: matrix.build_type == 'docker' || matrix.build_type == 'download'
        id: build-linux
        timeout-minutes: 180
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PLATFORM="${{ matrix.platform }}"

          echo "Building MariaDB $VERSION for $PLATFORM"

          pnpm download:mariadb -- \
            --version "$VERSION" \
            --platform "$PLATFORM" \
            --build-fallback \
            --output ./dist

          # Check if artifact was created
          shopt -s nullglob
          FILES=(./dist/mariadb-*.tar.gz ./dist/mariadb-*.zip)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "::error::No artifact created for $PLATFORM"
            exit 1
          fi
          ls -la ./dist/

      # For macOS: native build with Homebrew dependencies
      - name: Install macOS build dependencies
        if: matrix.build_type == 'native'
        run: |
          brew install cmake openssl@3 pcre2 lz4 xz zstd snappy jemalloc bison
          # Add Homebrew bison to PATH (system bison 2.3 is too old, need 2.4+)
          if [ -d "/opt/homebrew/opt/bison/bin" ]; then
            echo "/opt/homebrew/opt/bison/bin" >> $GITHUB_PATH
          elif [ -d "/usr/local/opt/bison/bin" ]; then
            echo "/usr/local/opt/bison/bin" >> $GITHUB_PATH
          fi

      - name: Build for macOS (native)
        if: matrix.build_type == 'native'
        id: build-macos
        timeout-minutes: 120
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PLATFORM="${{ matrix.platform }}"

          echo "Building MariaDB $VERSION for $PLATFORM (native macOS build)"

          # Get Homebrew prefix (differs between ARM64 and Intel macOS)
          BREW_PREFIX=$(brew --prefix)
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          BISON_PATH="$BREW_PREFIX/opt/bison/bin/bison"

          echo "Using OpenSSL at: $OPENSSL_PREFIX"
          echo "Using Bison at: $BISON_PATH"

          # Validate bison executable exists
          if [ ! -x "$BISON_PATH" ]; then
            echo "::error::Bison not found or not executable at $BISON_PATH"
            echo "Install with: brew install bison"
            exit 1
          fi

          # Verify bison version (need 2.4+)
          BISON_VERSION=$("$BISON_PATH" --version | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1)
          echo "Bison version: $BISON_VERSION (from $BISON_PATH)"

          BISON_MAJOR=$(echo "$BISON_VERSION" | cut -d. -f1)
          BISON_MINOR=$(echo "$BISON_VERSION" | cut -d. -f2)
          if [ "$BISON_MAJOR" -lt 2 ] || { [ "$BISON_MAJOR" -eq 2 ] && [ "$BISON_MINOR" -lt 4 ]; }; then
            echo "::error::Bison version $BISON_VERSION at $BISON_PATH is too old. MariaDB requires Bison >= 2.4"
            exit 1
          fi

          if [ ! -d "$OPENSSL_PREFIX" ]; then
            echo "::error::OpenSSL not found at $OPENSSL_PREFIX"
            exit 1
          fi

          # Clean up any previous build artifacts
          rm -rf mariadb-source.tar.gz mariadb-${VERSION} install dist

          # Download source
          curl -fsSL "https://archive.mariadb.org/mariadb-${VERSION}/source/mariadb-${VERSION}.tar.gz" \
            -o mariadb-source.tar.gz
          tar -xzf mariadb-source.tar.gz

          # Build in source directory
          SOURCE_DIR="$GITHUB_WORKSPACE/mariadb-${VERSION}"
          BUILD_DIR="$SOURCE_DIR/build"

          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"

          # Fix for Xcode 16+ SDK/toolchain mismatch issues
          # Force Xcode as the active developer directory and use its SDK
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

          # Get SDK and toolchain paths
          export SDKROOT=$(xcrun --sdk macosx --show-sdk-path)
          XCODE_TOOLCHAIN=$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain

          echo "Using Xcode SDK (SDKROOT): $SDKROOT"
          echo "Using Xcode Toolchain: $XCODE_TOOLCHAIN"

          # Set compiler environment variables to force correct SDK
          # These take precedence over any CMake-added flags
          export CC="$XCODE_TOOLCHAIN/usr/bin/clang"
          export CXX="$XCODE_TOOLCHAIN/usr/bin/clang++"
          export CFLAGS="--sysroot=$SDKROOT"
          export CXXFLAGS="--sysroot=$SDKROOT -stdlib=libc++"
          export LDFLAGS="--sysroot=$SDKROOT"

          # Verify clang uses correct SDK
          echo "Clang SDK check:"
          $CC --version
          $CC -v -E -x c /dev/null 2>&1 | grep "selected sysroot" || true

          # Configure (disable Columnstore as it has macOS compatibility issues)
          # Use xcrun to ensure cmake inherits correct SDK environment
          # Include both Xcode SDK and Homebrew in search paths (exclude Command Line Tools)
          xcrun cmake "$SOURCE_DIR" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/install/mariadb" \
            -DCMAKE_OSX_SYSROOT="$SDKROOT" \
            -DCMAKE_FIND_ROOT_PATH="$SDKROOT;$BREW_PREFIX" \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DZLIB_ROOT="$SDKROOT/usr" \
            -DBISON_EXECUTABLE="$BISON_PATH" \
            -DWITH_SSL="$OPENSSL_PREFIX" \
            -DWITH_GNUTLS=OFF \
            -DWITH_PCRE=system \
            -DWITH_JEMALLOC=system \
            -DWITH_UNIT_TESTS=OFF \
            -DPLUGIN_TOKUDB=NO \
            -DPLUGIN_ROCKSDB=NO \
            -DPLUGIN_MROONGA=NO \
            -DPLUGIN_SPIDER=NO \
            -DPLUGIN_SPHINX=NO \
            -DPLUGIN_CONNECT=NO \
            -DPLUGIN_OQGRAPH=NO \
            -DPLUGIN_COLUMNSTORE=NO \
            -DPLUGIN_S3=NO \
            -DCOMPILATION_COMMENT="hostdb build" \
            -DCOMPILATION_COMMENT_SERVER="Built by hostdb for spindb"

          # Build
          make -j$(sysctl -n hw.ncpu)

          # Install
          make install

          # Add metadata
          cd "$GITHUB_WORKSPACE/install"
          cat > mariadb/.hostdb-metadata.json << EOF
          {
            "name": "mariadb",
            "version": "${VERSION}",
            "platform": "${PLATFORM}",
            "source": "source-build",
            "sourceUrl": "https://archive.mariadb.org/",
            "rehosted_by": "hostdb",
            "rehosted_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Create tarball
          mkdir -p "$GITHUB_WORKSPACE/dist"
          tar -czvf "$GITHUB_WORKSPACE/dist/mariadb-${VERSION}-${PLATFORM}.tar.gz" mariadb

          echo "Build complete:"
          ls -la "$GITHUB_WORKSPACE/dist/"

      - name: Generate checksum
        run: |
          cd dist
          shopt -s nullglob
          for f in *.tar.gz *.zip; do
            if [ -f "$f" ]; then
              if command -v sha256sum &> /dev/null; then
                sha256sum "$f" >> checksums.txt
              else
                # macOS uses shasum
                shasum -a 256 "$f" >> checksums.txt
              fi
            fi
          done
          cat checksums.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-${{ github.event.inputs.version }}-${{ matrix.platform }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          retention-days: 1

  # Collect all artifacts and create release
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: mariadb-${{ github.event.inputs.version }}-*

      - name: Prepare release assets
        run: |
          mkdir -p ./release-assets

          # Move all artifacts to release-assets, flattening the directory structure
          find ./artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} ./release-assets/ \;

          # Combine all checksums
          find ./artifacts -name "checksums.txt" -exec cat {} \; > ./release-assets/checksums.txt

          echo "Release assets:"
          ls -la ./release-assets/

          # Verify we have at least one artifact
          shopt -s nullglob
          FILES=(./release-assets/*.tar.gz ./release-assets/*.zip)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "ERROR: No artifacts were created for any platform"
            exit 1
          fi

          echo ""
          echo "Checksums:"
          cat ./release-assets/checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mariadb-${{ github.event.inputs.version }}
          name: MariaDB ${{ github.event.inputs.version }}
          body: |
            ## MariaDB ${{ github.event.inputs.version }}

            MariaDB binaries for hostdb - all 5 platforms.

            ### Available Platforms
            | Platform | Source |
            |----------|--------|
            | `linux-x64` | Official binary or source build |
            | `linux-arm64` | Built from source (Docker) |
            | `darwin-x64` | Built from source (native macOS) |
            | `darwin-arm64` | Built from source (native macOS) |
            | `win32-x64` | Official binary |

            ### Usage
            ```bash
            # Download URL pattern
            https://github.com/${{ github.repository }}/releases/download/mariadb-${{ github.event.inputs.version }}/mariadb-${{ github.event.inputs.version }}-<platform>.tar.gz
            ```

            ### Checksums
            See `checksums.txt` for SHA256 checksums.

            ### Sources
            - **Official**: [MariaDB Archive](https://archive.mariadb.org/)
            - **Source Build**: Compiled from source for platforms without official binaries
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
            release-assets/checksums.txt
          fail_on_unmatched_files: false

  # Update the releases manifest
  update-manifest:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update releases.json
        run: |
          pnpm tsx scripts/update-releases.ts \
            --database mariadb \
            --version "${{ github.event.inputs.version }}" \
            --tag "mariadb-${{ github.event.inputs.version }}"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "chore: update releases.json for mariadb-${{ github.event.inputs.version }}"

          # Retry push with rebase if remote has changed
          for i in 1 2 3; do
            if git push; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed, attempting rebase (attempt $i/3)..."
            git fetch origin main
            if ! git rebase origin/main; then
              echo "ERROR: Rebase failed due to conflicts. Manual intervention required."
              git rebase --abort
              exit 1
            fi
            sleep $((2**i))
          done
          echo "ERROR: Push failed after 3 attempts"
          exit 1
