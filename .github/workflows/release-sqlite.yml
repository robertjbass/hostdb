name: Release SQLite

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'SQLite version'
        required: true
        type: choice
        options:
          - 3.51.2
        default: 3.51.2
      platforms:
        description: 'Platforms'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'linux-x64'
          - 'linux-arm64'
          - 'darwin-x64'
          - 'darwin-arm64'
          - 'win32-x64'

# Prevent concurrent runs that could conflict when updating releases.json
concurrency:
  group: release-sqlite
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version against databases.json
        run: |
          DB="sqlite"

          echo "Validating SQLite version: $VERSION"

          # Check if version exists and is enabled in databases.json
          ENABLED=$(jq -r ".databases.$DB.versions[\"$VERSION\"] // false" databases.json)
          if [ "$ENABLED" != "true" ]; then
            echo "::error::Version '$VERSION' is not enabled in databases.json"
            echo ""
            echo "Available versions:"
            jq -r ".databases.$DB.versions | to_entries | map(select(.value == true)) | .[].key" databases.json
            exit 1
          fi

          echo "✓ Version $VERSION is enabled in databases.json"

      - name: Validate sources.json exists
        run: |
          DB="sqlite"
          if [ ! -f "builds/$DB/sources.json" ]; then
            echo "::error::Missing builds/$DB/sources.json"
            exit 1
          fi
          echo "✓ builds/$DB/sources.json exists"

      - name: Validate version in sources.json
        run: |
          DB="sqlite"

          HAS_VERSION=$(jq -r ".versions[\"$VERSION\"] // empty" "builds/$DB/sources.json")
          if [ -z "$HAS_VERSION" ]; then
            echo "::error::Version '$VERSION' not found in builds/$DB/sources.json"
            echo ""
            echo "Available versions in sources.json:"
            jq -r ".versions | keys[]" "builds/$DB/sources.json"
            exit 1
          fi

          echo "✓ Version $VERSION found in sources.json"

  # Build Linux binaries from source for GLIBC 2.31 compatibility
  # Official SQLite binaries require GLIBC 2.38+ which breaks Ubuntu 22.04
  build-linux:
    needs: validate
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux-x64' || github.event.inputs.platforms == 'linux-arm64'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64
            docker_platform: linux/amd64
          - platform: linux-arm64
            docker_platform: linux/arm64
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Check if platform should be built
        id: check
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          PLATFORM="${{ matrix.platform }}"
          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "$PLATFORM" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Set up QEMU
        if: steps.check.outputs.should_build == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.check.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build SQLite for ${{ matrix.platform }}
        if: steps.check.outputs.should_build == 'true'
        run: |
          mkdir -p dist

          # Build Docker image for target platform
          docker buildx build \
            --platform ${{ matrix.docker_platform }} \
            --build-arg VERSION="$VERSION" \
            --load \
            -t sqlite-builder:$VERSION-${{ matrix.platform }} \
            builds/sqlite/

          # Extract artifact
          docker run --rm \
            --platform ${{ matrix.docker_platform }} \
            -v "$(pwd)/dist:/dist" \
            sqlite-builder:$VERSION-${{ matrix.platform }}

          ls -la dist/

      - name: Upload ${{ matrix.platform }} artifact
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-${{ matrix.platform }}-${{ github.event.inputs.version }}
          path: dist/*.tar.gz
          retention-days: 1

  # Download official binaries for non-Linux platforms (macOS, Windows)
  # Linux binaries are built from source for GLIBC compatibility
  build-download:
    needs: validate
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'darwin-x64' || github.event.inputs.platforms == 'darwin-arm64' || github.event.inputs.platforms == 'win32-x64'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
      PLATFORMS: ${{ github.event.inputs.platforms }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download and repackage SQLite
        run: |
          # Download for non-Linux platforms only (Linux is built from source)
          if [ "$PLATFORMS" = "all" ]; then
            for platform in darwin-x64 darwin-arm64 win32-x64; do
              pnpm download:sqlite -- --version "$VERSION" --platform "$platform" --output ./dist
            done
          else
            pnpm download:sqlite -- --version "$VERSION" --platform "$PLATFORMS" --output ./dist
          fi

          ls -la ./dist/

      - name: Upload download artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-downloads-${{ github.event.inputs.version }}
          path: |
            dist/*.tar.gz
            dist/*.zip
          retention-days: 1

  release:
    needs: [build-linux, build-download]
    if: always() && (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') && (needs.build-download.result == 'success' || needs.build-download.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download linux-x64 artifacts
        if: needs.build-linux.result == 'success' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux-x64')
        uses: actions/download-artifact@v4
        with:
          name: sqlite-linux-x64-${{ github.event.inputs.version }}
          path: ./release-assets
        continue-on-error: true

      - name: Download linux-arm64 artifacts
        if: needs.build-linux.result == 'success' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux-arm64')
        uses: actions/download-artifact@v4
        with:
          name: sqlite-linux-arm64-${{ github.event.inputs.version }}
          path: ./release-assets
        continue-on-error: true

      - name: Download non-Linux artifacts
        if: needs.build-download.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: sqlite-downloads-${{ github.event.inputs.version }}
          path: ./release-assets

      - name: Generate checksums
        run: |
          cd release-assets
          shopt -s nullglob
          files=(*.tar.gz *.zip)
          if [ ${#files[@]} -gt 0 ]; then
            sha256sum "${files[@]}" > checksums.txt
            echo "Generated checksums for ${#files[@]} file(s):"
            cat checksums.txt
          else
            echo "No .tar.gz or .zip files found - skipping checksum generation"
          fi

      - name: List release assets
        run: ls -la ./release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sqlite-${{ github.event.inputs.version }}
          name: SQLite ${{ github.event.inputs.version }}
          body: |
            ## SQLite ${{ github.event.inputs.version }}

            SQLite command-line tools repackaged for hostdb.

            SQLite is a self-contained, serverless, zero-configuration SQL database engine.

            ### License

            SQLite is in the **public domain**. No restrictions on use, modification, or distribution.

            ### Included Tools

            - `sqlite3` - Interactive command-line shell
            - `sqldiff` - Database diff utility
            - `sqlite3_analyzer` - Storage analyzer
            - `sqlite3_rsync` - Remote database sync

            ### Platforms
            - `linux-x64` - Linux x86_64 (source build, GLIBC 2.31+)
            - `linux-arm64` - Linux ARM64 (source build, GLIBC 2.31+)
            - `darwin-x64` - macOS Intel (official binary)
            - `darwin-arm64` - macOS Apple Silicon (official binary)
            - `win32-x64` - Windows x64 (official binary)

            ### Usage
            ```bash
            # Download URL pattern
            https://github.com/${{ github.repository }}/releases/download/sqlite-${{ github.event.inputs.version }}/sqlite-${{ github.event.inputs.version }}-<platform>.tar.gz
            ```

            ### Checksums
            See `checksums.txt` for SHA256 checksums.

            ### Source
            Official binaries from [sqlite.org](https://sqlite.org/download.html) for macOS and Windows.
            Linux binaries built from source on Ubuntu 20.04 for GLIBC 2.31 compatibility (works on Ubuntu 20.04+).
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
            release-assets/checksums.txt
          fail_on_unmatched_files: false

  update-manifest:
    needs: release
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update releases.json
        run: |
          pnpm tsx scripts/update-releases.ts \
            --database sqlite \
            --version "$VERSION" \
            --tag "sqlite-$VERSION"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "chore: update releases.json for sqlite-$VERSION"

          # Retry push with rebase if remote has changed
          for i in 1 2 3; do
            if git push; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed, attempting rebase (attempt $i/3)..."
            git fetch origin main
            if ! git rebase origin/main; then
              echo "ERROR: Rebase failed due to conflicts. Manual intervention required."
              git rebase --abort
              exit 1
            fi
            sleep $((2**i))
          done
          echo "ERROR: Push failed after 3 attempts"
          exit 1
