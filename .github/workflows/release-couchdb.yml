name: Release CouchDB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'CouchDB version'
        required: true
        type: choice
        options:
          - 3.5.1
        default: 3.5.1
      platforms:
        description: 'Platforms to build'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'linux-x64'
          - 'linux-arm64'
          - 'darwin-x64'
          - 'darwin-arm64'
          - 'win32-x64'

# Prevent concurrent runs that could conflict when updating releases.json
concurrency:
  group: release-couchdb
  cancel-in-progress: false

jobs:
  # Validate version against databases.json
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version against databases.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DB="couchdb"

          echo "Validating CouchDB version: $VERSION"

          # Check if version exists and is enabled in databases.json
          ENABLED=$(jq -r ".databases.$DB.versions[\"$VERSION\"] // false" databases.json)
          if [ "$ENABLED" != "true" ]; then
            echo "::error::Version '$VERSION' is not enabled in databases.json"
            echo ""
            echo "Available versions:"
            jq -r ".databases.$DB.versions | to_entries | map(select(.value == true)) | .[].key" databases.json
            exit 1
          fi

          echo "✓ Version $VERSION is enabled in databases.json"

      - name: Validate sources.json exists
        run: |
          DB="couchdb"
          if [ ! -f "builds/$DB/sources.json" ]; then
            echo "::error::Missing builds/$DB/sources.json"
            exit 1
          fi
          echo "✓ builds/$DB/sources.json exists"

      - name: Validate version in sources.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DB="couchdb"

          HAS_VERSION=$(jq -r ".versions[\"$VERSION\"] // empty" "builds/$DB/sources.json")
          if [ -z "$HAS_VERSION" ]; then
            echo "::error::Version '$VERSION' not found in builds/$DB/sources.json"
            echo ""
            echo "Available versions in sources.json:"
            jq -r ".versions | keys[]" "builds/$DB/sources.json"
            exit 1
          fi

          echo "✓ Version $VERSION found in sources.json"

  # Determine which platforms to build based on input
  prepare:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          if [ "$PLATFORMS" = "all" ]; then
            # All 5 platforms with their appropriate runners and build types
            # - Linux: Docker extraction from official CouchDB image
            # - macOS: Download from Neighbourhoodie
            # - Windows: Download MSI and extract on Windows runner
            MATRIX='[
              {"platform": "linux-x64", "runner": "ubuntu-latest", "build_type": "docker"},
              {"platform": "linux-arm64", "runner": "ubuntu-latest", "build_type": "docker"},
              {"platform": "darwin-x64", "runner": "ubuntu-latest", "build_type": "download"},
              {"platform": "darwin-arm64", "runner": "ubuntu-latest", "build_type": "download"},
              {"platform": "win32-x64", "runner": "windows-latest", "build_type": "msi-extract"}
            ]'
          else
            # Single platform - determine runner and build type
            case "$PLATFORMS" in
              linux-x64|linux-arm64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"ubuntu-latest\", \"build_type\": \"docker\"}]"
                ;;
              darwin-x64|darwin-arm64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"ubuntu-latest\", \"build_type\": \"download\"}]"
                ;;
              win32-x64)
                MATRIX="[{\"platform\": \"$PLATFORMS\", \"runner\": \"windows-latest\", \"build_type\": \"msi-extract\"}]"
                ;;
            esac
          fi
          # Compact the JSON for output
          MATRIX=$(echo "$MATRIX" | jq -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Building platforms: $MATRIX"

  # Build each platform in parallel
  build:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Set up QEMU for cross-platform Docker builds (required for linux-arm64 on x64 runners)
      - name: Set up QEMU
        if: matrix.build_type == 'docker'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: matrix.build_type == 'docker'
        uses: docker/setup-buildx-action@v3

      # For Linux: extract from official Docker image
      - name: Build for Linux (Docker extraction)
        if: matrix.build_type == 'docker'
        id: build-linux
        timeout-minutes: 30
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PLATFORM="${{ matrix.platform }}"

          echo "Extracting CouchDB $VERSION for $PLATFORM from Docker image"

          # Map hostdb platform to Docker platform
          case "$PLATFORM" in
            linux-x64) DOCKER_PLATFORM="linux/amd64" ;;
            linux-arm64) DOCKER_PLATFORM="linux/arm64" ;;
          esac

          # Build with Docker and extract files
          docker buildx build \
            --platform "$DOCKER_PLATFORM" \
            --build-arg VERSION="$VERSION" \
            --output "type=local,dest=./temp-extract" \
            --file builds/couchdb/Dockerfile \
            .

          # Verify extraction
          if [ ! -d "./temp-extract/couchdb" ]; then
            echo "::error::Extraction failed - couchdb directory not found"
            ls -la ./temp-extract/
            exit 1
          fi

          # Create tarball
          mkdir -p ./dist
          tar -czvf "./dist/couchdb-${VERSION}-${PLATFORM}.tar.gz" -C ./temp-extract couchdb

          echo "Build complete:"
          ls -la ./dist/

      # For macOS: download from Neighbourhoodie and repackage
      - name: Download for macOS
        if: matrix.build_type == 'download'
        id: build-macos
        timeout-minutes: 30
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PLATFORM="${{ matrix.platform }}"

          echo "Downloading CouchDB $VERSION for $PLATFORM"

          pnpm download:couchdb -- \
            --version "$VERSION" \
            --platform "$PLATFORM" \
            --output ./dist

          # Check if artifact was created
          shopt -s nullglob
          FILES=(./dist/couchdb-*.tar.gz ./dist/couchdb-*.zip)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "::error::No artifact created for $PLATFORM"
            exit 1
          fi
          ls -la ./dist/

      # For Windows: install MSI, copy files, then uninstall
      # Using actual install instead of extraction (/a) because extraction breaks
      # Erlang port communication for os_mon/win32sysinfo.exe
      - name: Install and capture MSI for Windows
        if: matrix.build_type == 'msi-extract'
        id: build-windows
        timeout-minutes: 30
        shell: pwsh
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          $PLATFORM = "${{ matrix.platform }}"

          Write-Host "Downloading CouchDB $VERSION MSI for $PLATFORM"

          # Download MSI
          $msiUrl = "https://couchdb.neighbourhood.ie/downloads/$VERSION/win/apache-couchdb-$VERSION.msi"
          $msiPath = ".\couchdb-$VERSION.msi"

          Write-Host "Downloading: $msiUrl"
          Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath -UseBasicParsing

          # Verify download
          if (-not (Test-Path $msiPath)) {
            Write-Error "Download failed"
            exit 1
          }

          Write-Host "MSI downloaded: $(Get-Item $msiPath | Select-Object -ExpandProperty Length) bytes"

          # Install MSI to a custom directory (not just extract)
          # Using /i (install) instead of /a (admin extract) because extraction
          # breaks Erlang port communication for win32sysinfo.exe
          $installDir = "C:\CouchDB"

          Write-Host "Installing CouchDB to $installDir..."
          $msiFullPath = (Get-Item $msiPath).FullName

          # Install without starting service, to custom directory
          $args = "/i `"$msiFullPath`" /qn INSTALLDIR=`"$installDir`" INSTALLFOLDER=`"$installDir`" INSTALLSERVICE=0 /l*v install.log"
          Write-Host "Running: msiexec $args"
          $process = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru

          # Always show install log for debugging
          Write-Host "MSI install exit code: $($process.ExitCode)"
          if (Test-Path "install.log") {
            Write-Host "=== Install log (last 50 lines) ==="
            Get-Content "install.log" | Select-Object -Last 50
            Write-Host "=== End install log ==="
          }

          # Find CouchDB installation - search broadly
          Write-Host "Looking for CouchDB installation..."

          # Check common installation paths
          $possiblePaths = @(
            $installDir,
            "C:\CouchDB",
            "C:\Apache CouchDB",
            "C:\Program Files\Apache CouchDB",
            "C:\Program Files\Apache Software Foundation\CouchDB",
            "C:\Program Files (x86)\Apache CouchDB",
            "C:\Program Files (x86)\Apache Software Foundation\CouchDB",
            "$env:ProgramFiles\Apache CouchDB",
            "$env:ProgramFiles\Apache Software Foundation\CouchDB"
          )

          $couchdbDir = $null
          foreach ($path in $possiblePaths) {
            Write-Host "Checking: $path"
            if (Test-Path $path) {
              Write-Host "  Directory exists, contents:"
              Get-ChildItem $path | ForEach-Object { Write-Host "    $($_.Name)" }
              if (Test-Path "$path\bin\couchdb.cmd") {
                $couchdbDir = Get-Item $path
                Write-Host "  Found couchdb.cmd!"
                break
              }
            }
          }

          # If not found, search Program Files for anything CouchDB related
          if (-not $couchdbDir) {
            Write-Host "Searching Program Files for CouchDB..."
            $searchPaths = @("C:\Program Files", "C:\Program Files (x86)", "C:\")
            foreach ($searchPath in $searchPaths) {
              if (Test-Path $searchPath) {
                $found = Get-ChildItem -Path $searchPath -Directory -ErrorAction SilentlyContinue |
                  Where-Object { $_.Name -like "*CouchDB*" -or $_.Name -like "*Apache*" }
                foreach ($dir in $found) {
                  Write-Host "Found potential match: $($dir.FullName)"
                  if (Test-Path "$($dir.FullName)\bin\couchdb.cmd") {
                    $couchdbDir = $dir
                    Write-Host "  Contains couchdb.cmd!"
                    break
                  }
                  # Check subdirectories
                  $subDirs = Get-ChildItem -Path $dir.FullName -Directory -ErrorAction SilentlyContinue
                  foreach ($subDir in $subDirs) {
                    if (Test-Path "$($subDir.FullName)\bin\couchdb.cmd") {
                      $couchdbDir = $subDir
                      Write-Host "  Found in subdirectory: $($subDir.FullName)"
                      break
                    }
                  }
                  if ($couchdbDir) { break }
                }
              }
              if ($couchdbDir) { break }
            }
          }

          if (-not $couchdbDir) {
            Write-Error "Could not find CouchDB installation after extensive search"
            exit 1
          }

          Write-Host "Found CouchDB at: $($couchdbDir.FullName)"

          # Create final directory structure
          $finalDir = ".\final\couchdb"
          New-Item -ItemType Directory -Force -Path $finalDir

          # Copy CouchDB files
          Copy-Item -Path "$($couchdbDir.FullName)\*" -Destination $finalDir -Recurse -Force

          # Add metadata
          $metadata = @{
            name = "couchdb"
            version = $VERSION
            platform = $PLATFORM
            source = "neighbourhoodie"
            sourceUrl = "https://neighbourhood.ie/couchdb-support/download-binaries"
            rehosted_by = "hostdb"
            rehosted_at = (Get-Date -Format "o")
          } | ConvertTo-Json
          $metadata | Out-File -FilePath "$finalDir\.hostdb-metadata.json" -Encoding UTF8

          # Verify key files
          if (-not (Test-Path "$finalDir\bin")) {
            Write-Host "Warning: bin directory not found"
            Write-Host "Contents of final directory:"
            Get-ChildItem -Path $finalDir -Recurse | Select-Object -First 30 | ForEach-Object { Write-Host $_.FullName }
          }

          # Create ZIP
          New-Item -ItemType Directory -Force -Path ".\dist"
          $zipPath = ".\dist\couchdb-$VERSION-$PLATFORM.zip"

          Compress-Archive -Path ".\final\couchdb" -DestinationPath $zipPath -Force

          # Uninstall CouchDB to clean up
          Write-Host "Uninstalling CouchDB..."
          $uninstallArgs = "/x `"$msiFullPath`" /qn"
          Start-Process msiexec.exe -ArgumentList $uninstallArgs -Wait -NoNewWindow

          Write-Host "Build complete:"
          Get-ChildItem -Path ".\dist"

      - name: Generate checksum
        shell: bash
        run: |
          cd dist
          shopt -s nullglob
          for f in *.tar.gz *.zip; do
            if [ -f "$f" ]; then
              if command -v sha256sum &> /dev/null; then
                sha256sum "$f" >> checksums.txt
              else
                # macOS/Windows use different tools
                shasum -a 256 "$f" >> checksums.txt 2>/dev/null || \
                  certutil -hashfile "$f" SHA256 | grep -v ":" >> checksums.txt
              fi
            fi
          done
          cat checksums.txt || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: couchdb-${{ github.event.inputs.version }}-${{ matrix.platform }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          retention-days: 1

  # Collect all artifacts and create release
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: couchdb-${{ github.event.inputs.version }}-*

      - name: Prepare release assets
        run: |
          mkdir -p ./release-assets

          # Move all artifacts to release-assets, flattening the directory structure
          find ./artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} ./release-assets/ \;

          # Combine all checksums
          find ./artifacts -name "checksums.txt" -exec cat {} \; > ./release-assets/checksums.txt

          echo "Release assets:"
          ls -la ./release-assets/

          # Verify we have at least one artifact
          shopt -s nullglob
          FILES=(./release-assets/*.tar.gz ./release-assets/*.zip)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "ERROR: No artifacts were created for any platform"
            exit 1
          fi

          echo ""
          echo "Checksums:"
          cat ./release-assets/checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: couchdb-${{ github.event.inputs.version }}
          name: CouchDB ${{ github.event.inputs.version }}
          body: |
            ## CouchDB ${{ github.event.inputs.version }}

            Apache CouchDB binaries for hostdb - all 5 platforms.

            ### Available Platforms
            | Platform | Source |
            |----------|--------|
            | `linux-x64` | Extracted from official Docker image |
            | `linux-arm64` | Extracted from official Docker image |
            | `darwin-x64` | [Neighbourhoodie](https://neighbourhood.ie/couchdb-support/download-binaries) |
            | `darwin-arm64` | [Neighbourhoodie](https://neighbourhood.ie/couchdb-support/download-binaries) |
            | `win32-x64` | [Neighbourhoodie](https://neighbourhood.ie/couchdb-support/download-binaries) MSI |

            ### Usage
            ```bash
            # Download URL pattern
            https://github.com/${{ github.repository }}/releases/download/couchdb-${{ github.event.inputs.version }}/couchdb-${{ github.event.inputs.version }}-<platform>.tar.gz
            ```

            ### Checksums
            See `checksums.txt` for SHA256 checksums.

            ### License
            Apache CouchDB is licensed under Apache-2.0.

            ### Sources
            - **Official Docker Image**: [hub.docker.com/_/couchdb](https://hub.docker.com/_/couchdb)
            - **macOS/Windows Binaries**: [Neighbourhoodie](https://neighbourhood.ie/couchdb-support/download-binaries)
            - **Official Website**: [couchdb.apache.org](https://couchdb.apache.org/)
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
            release-assets/checksums.txt
          fail_on_unmatched_files: false

  # Update the releases manifest
  update-manifest:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update releases.json
        run: |
          pnpm tsx scripts/update-releases.ts \
            --database couchdb \
            --version "${{ github.event.inputs.version }}" \
            --tag "couchdb-${{ github.event.inputs.version }}"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "chore: update releases.json for couchdb-${{ github.event.inputs.version }}"

          # Retry push with rebase if remote has changed
          for i in 1 2 3; do
            if git push; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed, attempting rebase (attempt $i/3)..."
            git fetch origin main
            if ! git rebase origin/main; then
              echo "ERROR: Rebase failed due to conflicts. Manual intervention required."
              git rebase --abort
              exit 1
            fi
            sleep $((2**i))
          done
          echo "ERROR: Push failed after 3 attempts"
          exit 1
