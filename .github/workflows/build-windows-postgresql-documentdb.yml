name: Build Windows PostgreSQL-DocumentDB

# Debug workflow for iterating on Windows builds
# Does NOT create releases - just builds and uploads artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: choice
        options:
          - 17-0.107.0
        default: 17-0.107.0
      phase:
        description: 'Build phase (incremental development)'
        required: true
        type: choice
        options:
          - '1-pgvector-only'
          - '2-add-pg_cron-rum'
          - '3-add-documentdb'
          - '4-full-bundle'
        default: '1-pgvector-only'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download PostgreSQL Windows binaries
        shell: pwsh
        run: |
          Write-Host "=== Downloading PostgreSQL 17 for Windows ==="

          $PG_URL = "https://sbp.enterprisedb.com/getfile.jsp?fileid=1259911"
          $PG_DIR = "C:\pg-windows"

          New-Item -ItemType Directory -Force -Path $PG_DIR | Out-Null
          Set-Location $PG_DIR

          Write-Host "Downloading from: $PG_URL"
          Invoke-WebRequest -Uri $PG_URL -OutFile postgresql.zip

          Write-Host "Extracting..."
          Expand-Archive -Path postgresql.zip -DestinationPath .

          # Rename to consistent name
          if (Test-Path "pgsql") {
            Rename-Item "pgsql" "postgresql"
          }

          Write-Host "PostgreSQL installed at: $PG_DIR\postgresql"
          Get-ChildItem -Path postgresql
          Get-ChildItem -Path postgresql\bin | Select-Object -First 10

          # Verify pg_config exists
          if (Test-Path "postgresql\bin\pg_config.exe") {
            Write-Host "pg_config found!"
            & .\postgresql\bin\pg_config.exe --version
            & .\postgresql\bin\pg_config.exe --pgxs
          } else {
            Write-Error "pg_config.exe not found!"
            exit 1
          }

      - name: Setup Visual Studio Developer Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build pgvector with MSVC (Phase 1)
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set VERSION=${{ github.event.inputs.version }}
          set PGVECTOR_VERSION=0.8.0
          set PGROOT=C:\pg-windows\postgresql

          echo === Building pgvector v%PGVECTOR_VERSION% with MSVC ===
          echo PGROOT: %PGROOT%

          :: Clone pgvector
          echo Current directory: %CD%
          mkdir C:\build 2>nul
          cd /d C:\build
          echo After cd: %CD%

          if not exist pgvector (
            echo Cloning pgvector...
            git clone --depth 1 --branch v%PGVECTOR_VERSION% https://github.com/pgvector/pgvector.git
          ) else (
            echo pgvector already exists
          )

          echo Contents of C:\build:
          dir C:\build

          cd /d C:\build\pgvector
          echo Final directory: %CD%

          :: Show Windows Makefile
          echo.
          echo === pgvector Makefile.win (first 30 lines) ===
          more +1 Makefile.win | findstr /n "^" | findstr "^[1-9]:" | findstr /v "^[3-9][0-9]:"

          echo.
          echo === Building with nmake and Makefile.win ===

          :: pgvector has Windows-specific Makefile.win for MSVC builds
          nmake /F Makefile.win

          if errorlevel 1 (
            echo.
            echo === Build failed ===
            echo.
            echo Checking PGROOT contents...
            dir "%PGROOT%\include" 2>nul | head -10
            dir "%PGROOT%\lib" 2>nul | head -10
            exit /b 1
          )

          echo.
          echo === Build succeeded! ===
          dir *.dll 2>nul || dir

      - name: Install and verify pgvector
        if: success()
        shell: cmd
        run: |
          @echo off
          set PGROOT=C:\pg-windows\postgresql

          echo Current directory: %CD%
          echo Checking if C:\build\pgvector exists...
          if exist C:\build\pgvector (
            echo Directory exists!
            dir C:\build\pgvector
          ) else (
            echo ERROR: C:\build\pgvector does not exist!
            echo Contents of C:\build:
            dir C:\build 2>nul || echo C:\build does not exist either
            exit /b 1
          )

          cd /d C:\build\pgvector
          echo After cd: %CD%

          echo === Installing pgvector ===
          nmake /F Makefile.win install

          if errorlevel 1 (
            echo Install failed
            exit /b 1
          )

          echo.
          echo === Verifying installation ===

          echo.
          echo Extension control file:
          dir "%PGROOT%\share\extension\vector*" 2>nul || echo Not found

          echo.
          echo Extension library:
          dir "%PGROOT%\lib\vector*" 2>nul || echo Not found

      - name: Build pg_cron with MSVC (Phase 2+)
        if: success() && github.event.inputs.phase != '1-pgvector-only'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $PG_CRON_VERSION = "1.6.5"
          $env:PGROOT = "C:\pg-windows\postgresql"

          Write-Host "=== Building pg_cron v$PG_CRON_VERSION with MSVC ==="

          Set-Location C:\build

          if (-not (Test-Path "pg_cron")) {
            git clone --depth 1 --branch "v$PG_CRON_VERSION" https://github.com/citusdata/pg_cron.git
          }

          Set-Location C:\build\pg_cron

          Write-Host "`n=== Creating Makefile.win for pg_cron ==="

          # Create Windows makefile for pg_cron
          @"
          EXTENSION = pg_cron
          EXTVERSION = $PG_CRON_VERSION

          OBJS = src\entry.obj src\job_metadata.obj src\misc.obj src\pg_cron.obj src\task_states.obj

          !ifndef PGROOT
          !error PGROOT is not set
          !endif
          BINDIR = `$(PGROOT)\bin
          INCLUDEDIR = `$(PGROOT)\include
          INCLUDEDIR_SERVER = `$(PGROOT)\include\server
          LIBDIR = `$(PGROOT)\lib
          PKGLIBDIR = `$(PGROOT)\lib
          SHAREDIR = `$(PGROOT)\share

          CFLAGS = /nologo /I"`$(INCLUDEDIR_SERVER)\port\win32_msvc" /I"`$(INCLUDEDIR_SERVER)\port\win32" /I"`$(INCLUDEDIR_SERVER)" /I"`$(INCLUDEDIR)" /Iinclude /DWIN32 /D_WINDOWS

          SHLIB = `$(EXTENSION).dll
          LIBS = "`$(LIBDIR)\postgres.lib"

          all: `$(SHLIB)

          .c.obj:
          	`$(CC) `$(CFLAGS) /c `$< /Fo`$@

          `$(SHLIB): `$(OBJS)
          	`$(CC) `$(CFLAGS) `$(OBJS) `$(LIBS) /link /DLL /OUT:`$(SHLIB)

          install: all
          	copy `$(SHLIB) "`$(PKGLIBDIR)"
          	copy `$(EXTENSION).control "`$(SHAREDIR)\extension"
          	copy `$(EXTENSION)--*.sql "`$(SHAREDIR)\extension"

          clean:
          	del /f `$(SHLIB) `$(EXTENSION).lib `$(EXTENSION).exp `$(OBJS)
          "@ | Out-File -FilePath Makefile.win -Encoding ascii

          Write-Host "`n=== Contents of generated Makefile.win ==="
          Get-Content Makefile.win

          Write-Host "`n=== Building pg_cron ==="
          nmake /F Makefile.win
          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n=== pg_cron build failed ==="
            exit 1
          }

          Write-Host "`n=== Installing pg_cron ==="
          nmake /F Makefile.win install
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Install failed"
            exit 1
          }

          Write-Host "`n=== pg_cron build and install succeeded ==="
          Get-ChildItem "$env:PGROOT\lib\pg_cron*"
          Get-ChildItem "$env:PGROOT\share\extension\pg_cron*"

      - name: Build rum with MSVC (Phase 2+)
        if: success() && github.event.inputs.phase != '1-pgvector-only'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $RUM_VERSION = "1.3.14"
          $env:PGROOT = "C:\pg-windows\postgresql"

          Write-Host "=== Building rum v$RUM_VERSION with MSVC ==="

          Set-Location C:\build

          if (-not (Test-Path "rum")) {
            git clone --depth 1 --branch $RUM_VERSION https://github.com/postgrespro/rum.git
          }

          Set-Location C:\build\rum

          Write-Host "`n=== Checking rum source files ==="
          Get-ChildItem src\*.c

          # Get list of source files
          $sourceFiles = Get-ChildItem src\*.c | ForEach-Object { "src\$($_.BaseName).obj" }
          $OBJS = $sourceFiles -join " "

          Write-Host "`n=== Creating Makefile.win for rum ==="
          Write-Host "OBJS = $OBJS"

          @"
          EXTENSION = rum
          EXTVERSION = $RUM_VERSION

          OBJS = $OBJS

          !ifndef PGROOT
          !error PGROOT is not set
          !endif
          BINDIR = `$(PGROOT)\bin
          INCLUDEDIR = `$(PGROOT)\include
          INCLUDEDIR_SERVER = `$(PGROOT)\include\server
          LIBDIR = `$(PGROOT)\lib
          PKGLIBDIR = `$(PGROOT)\lib
          SHAREDIR = `$(PGROOT)\share

          CFLAGS = /nologo /I"`$(INCLUDEDIR_SERVER)\port\win32_msvc" /I"`$(INCLUDEDIR_SERVER)\port\win32" /I"`$(INCLUDEDIR_SERVER)" /I"`$(INCLUDEDIR)" /Isrc /DWIN32 /D_WINDOWS

          SHLIB = `$(EXTENSION).dll
          LIBS = "`$(LIBDIR)\postgres.lib"

          all: `$(SHLIB)

          .c.obj:
          	`$(CC) `$(CFLAGS) /c `$< /Fo`$@

          `$(SHLIB): `$(OBJS)
          	`$(CC) `$(CFLAGS) `$(OBJS) `$(LIBS) /link /DLL /OUT:`$(SHLIB)

          install: all
          	copy `$(SHLIB) "`$(PKGLIBDIR)"
          	copy `$(EXTENSION).control "`$(SHAREDIR)\extension"
          	copy `$(EXTENSION)--*.sql "`$(SHAREDIR)\extension"

          clean:
          	del /f `$(SHLIB) `$(EXTENSION).lib `$(EXTENSION).exp `$(OBJS)
          "@ | Out-File -FilePath Makefile.win -Encoding ascii

          Write-Host "`n=== Contents of generated Makefile.win ==="
          Get-Content Makefile.win

          Write-Host "`n=== Building rum ==="
          nmake /F Makefile.win
          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n=== rum build failed ==="
            exit 1
          }

          Write-Host "`n=== Installing rum ==="
          nmake /F Makefile.win install
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Install failed"
            exit 1
          }

          Write-Host "`n=== rum build and install succeeded ==="
          Get-ChildItem "$env:PGROOT\lib\rum*"
          Get-ChildItem "$env:PGROOT\share\extension\rum*"

      - name: Create artifact
        if: success()
        shell: pwsh
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          $PHASE = "${{ github.event.inputs.phase }}"
          $PG_DIR = "C:\pg-windows\postgresql"

          Write-Host "=== Creating artifact ==="

          New-Item -ItemType Directory -Force -Path C:\output | Out-Null
          Set-Location C:\output

          # Copy PostgreSQL with installed extensions
          Copy-Item -Recurse -Path $PG_DIR -Destination .\postgresql-documentdb

          # Add metadata
          $metadata = @{
            name = "postgresql-documentdb"
            version = $VERSION
            platform = "win32-x64"
            phase = $PHASE
            source = "windows-build-debug"
            rehosted_by = "hostdb"
            rehosted_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          } | ConvertTo-Json

          $metadata | Out-File -FilePath ".\postgresql-documentdb\.hostdb-metadata.json" -Encoding utf8

          # Create zip
          $zipName = "postgresql-documentdb-$VERSION-win32-x64-$PHASE.zip"
          Compress-Archive -Path .\postgresql-documentdb -DestinationPath $zipName

          Write-Host ""
          Write-Host "=== Artifact created ==="
          Get-ChildItem *.zip

          # Calculate checksum
          $hash = Get-FileHash -Algorithm SHA256 $zipName
          "$($hash.Hash)  $zipName" | Out-File -FilePath checksums.txt -Encoding utf8
          Get-Content checksums.txt

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-documentdb-${{ github.event.inputs.version }}-win32-x64-${{ github.event.inputs.phase }}
          path: |
            C:/output/*.zip
            C:/output/checksums.txt
          retention-days: 7
