name: Build Windows PostgreSQL-DocumentDB

# Debug workflow for iterating on Windows builds
# Does NOT create releases - just builds and uploads artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: choice
        options:
          - 17-0.107.0
        default: 17-0.107.0
      phase:
        description: 'Build phase (incremental development)'
        required: true
        type: choice
        options:
          - '1-pgvector-only'
          - '2-add-pg_cron-rum'
          - '3-add-documentdb'
          - '4-full-bundle'
        default: '1-pgvector-only'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-tools-git
            make
            git
            zip
            unzip
            curl
            tar

      - name: Download PostgreSQL Windows binaries
        shell: msys2 {0}
        run: |
          set -euo pipefail

          VERSION="${{ github.event.inputs.version }}"
          PG_MAJOR="${VERSION%%-*}"  # "17" from "17-0.107.0"

          echo "=== Downloading PostgreSQL $PG_MAJOR for Windows ==="

          mkdir -p /c/pg-windows
          cd /c/pg-windows

          # Download from EDB (using the file ID from sources.json)
          # PostgreSQL 17.7.0 for Windows
          PG_URL="https://sbp.enterprisedb.com/getfile.jsp?fileid=1259911"

          echo "Downloading from: $PG_URL"
          curl -fsSL -o postgresql.zip "$PG_URL"

          echo "Extracting..."
          unzip -q postgresql.zip

          # Find the extracted directory (usually pgsql/)
          ls -la

          # Move to a known location
          if [ -d "pgsql" ]; then
            mv pgsql postgresql
          fi

          echo "PostgreSQL installed at: /c/pg-windows/postgresql"
          ls -la postgresql/
          ls -la postgresql/bin/ | head -10

          # Verify pg_config exists
          if [ -f "postgresql/bin/pg_config.exe" ]; then
            echo "pg_config found!"
            ./postgresql/bin/pg_config.exe --version
            ./postgresql/bin/pg_config.exe --pgxs
          else
            echo "ERROR: pg_config.exe not found!"
            exit 1
          fi

      - name: Build pgvector (Phase 1)
        shell: msys2 {0}
        run: |
          set -euo pipefail

          VERSION="${{ github.event.inputs.version }}"
          PGVECTOR_VERSION="0.8.0"
          PG_DIR="/c/pg-windows/postgresql"

          echo "=== Building pgvector v${PGVECTOR_VERSION} ==="
          echo "PG_DIR: $PG_DIR"

          mkdir -p /c/build
          cd /c/build

          # Clone pgvector
          if [ ! -d "pgvector" ]; then
            git clone --depth 1 --branch "v${PGVECTOR_VERSION}" https://github.com/pgvector/pgvector.git
          fi

          cd pgvector

          echo ""
          echo "=== Manual build (bypassing PGXS - MSVC incompatible with GCC) ==="

          # EDB PostgreSQL was built with MSVC. Its PGXS uses MSVC-style flags
          # like /DWIN32 that GCC interprets as paths. We must bypass PGXS
          # and compile manually with GCC.

          # Compiler flags for PostgreSQL extensions on Windows
          PG_INCLUDE="$PG_DIR/include/server"
          PG_INCLUDE_WIN32="$PG_DIR/include/server/port/win32"
          PG_LIB="$PG_DIR/lib"

          CFLAGS="-O2 -Wall -I$PG_INCLUDE -I$PG_INCLUDE_WIN32 -DWIN32 -D_WIN32 -D__WIN32__"
          LDFLAGS="-shared -L$PG_LIB"

          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"

          # List source files
          SOURCES=$(ls src/*.c)
          echo "Source files: $SOURCES"

          # Compile each source file
          echo ""
          echo "=== Compiling ==="
          for src in $SOURCES; do
            obj="${src%.c}.o"
            echo "  $src -> $obj"
            gcc $CFLAGS -c -o "$obj" "$src" || {
              echo "Failed to compile $src"
              exit 1
            }
          done

          # Create MinGW-compatible import library from postgres.exe
          # The MSVC postgres.lib doesn't work with MinGW's linker
          echo ""
          echo "=== Creating MinGW import library from postgres.exe ==="
          PG_BIN="$PG_DIR/bin"

          if [ -f "$PG_BIN/postgres.exe" ]; then
            echo "Found postgres.exe, creating import library..."

            # Generate .def file from postgres.exe exports
            gendef "$PG_BIN/postgres.exe" 2>/dev/null || {
              echo "gendef failed, trying pexports..."
              pexports "$PG_BIN/postgres.exe" > postgres.def 2>/dev/null || {
                echo "Could not extract exports from postgres.exe"
                exit 1
              }
            }

            # Check if def file was created
            if [ -f "postgres.def" ]; then
              echo "Generated postgres.def"
              head -20 postgres.def
            else
              echo "ERROR: postgres.def not found"
              ls -la *.def 2>/dev/null || echo "No .def files"
              exit 1
            fi

            # Create import library with dlltool
            dlltool -d postgres.def -l libpostgres.a -D postgres.exe
            echo "Created libpostgres.a"
            ls -la libpostgres.a
          else
            echo "ERROR: postgres.exe not found at $PG_BIN/postgres.exe"
            ls -la "$PG_BIN/" | head -20
            exit 1
          fi

          # Link into DLL
          echo ""
          echo "=== Linking vector.dll ==="
          OBJECTS=$(ls src/*.o)

          gcc $LDFLAGS -o vector.dll $OBJECTS -L. -lpostgres || {
            echo ""
            echo "=== Link failed with libpostgres.a ==="
            echo "Trying to link directly against postgres.exe..."
            gcc $LDFLAGS -o vector.dll $OBJECTS "$PG_BIN/postgres.exe" || {
              echo "Direct link also failed"
              exit 1
            }
          }

          echo ""
          echo "=== Build succeeded! ==="
          ls -la *.dll 2>/dev/null || ls -la

      - name: Install and test pgvector
        if: success()
        shell: msys2 {0}
        run: |
          set -euo pipefail

          PG_DIR="/c/pg-windows/postgresql"
          PG_CONFIG="${PG_DIR}/bin/pg_config.exe"

          cd /c/build/pgvector

          echo "=== Installing pgvector ==="
          make PG_CONFIG="$PG_CONFIG" install

          echo ""
          echo "=== Verifying installation ==="

          # Check if extension files were installed
          SHAREDIR=$($PG_CONFIG --sharedir)
          PKGLIBDIR=$($PG_CONFIG --pkglibdir)

          echo "Share dir: $SHAREDIR"
          echo "Lib dir: $PKGLIBDIR"

          echo ""
          echo "Extension control file:"
          ls -la "$SHAREDIR/extension/"vector* 2>/dev/null || echo "Not found in sharedir"

          echo ""
          echo "Extension library:"
          ls -la "$PKGLIBDIR/"vector* 2>/dev/null || echo "Not found in pkglibdir"

      - name: Create artifact
        if: success()
        shell: msys2 {0}
        run: |
          set -euo pipefail

          VERSION="${{ github.event.inputs.version }}"
          PHASE="${{ github.event.inputs.phase }}"
          PG_DIR="/c/pg-windows/postgresql"

          echo "=== Creating artifact ==="

          mkdir -p /c/output
          cd /c/output

          # Copy PostgreSQL with installed extensions
          cp -r "$PG_DIR" ./postgresql-documentdb

          # Add metadata
          cat > postgresql-documentdb/.hostdb-metadata.json << EOF
          {
            "name": "postgresql-documentdb",
            "version": "${VERSION}",
            "platform": "win32-x64",
            "phase": "${PHASE}",
            "source": "windows-build-debug",
            "rehosted_by": "hostdb",
            "rehosted_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Create zip
          zip -r "postgresql-documentdb-${VERSION}-win32-x64-${PHASE}.zip" postgresql-documentdb

          echo ""
          echo "=== Artifact created ==="
          ls -la *.zip

          # Calculate checksum
          sha256sum *.zip > checksums.txt
          cat checksums.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-documentdb-${{ github.event.inputs.version }}-win32-x64-${{ github.event.inputs.phase }}
          path: |
            C:/output/*.zip
            C:/output/checksums.txt
          retention-days: 7
