name: Build Windows PostgreSQL-DocumentDB

# Debug workflow for iterating on Windows builds
# Does NOT create releases - just builds and uploads artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: choice
        options:
          - 17-0.107.0
        default: 17-0.107.0
      phase:
        description: 'Build phase (incremental development)'
        required: true
        type: choice
        options:
          - '1-pgvector-only'
          - '2-add-pg_cron-rum'
          - '3-add-documentdb'
          - '4-full-bundle'
        default: '1-pgvector-only'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download PostgreSQL Windows binaries
        shell: pwsh
        run: |
          Write-Host "=== Downloading PostgreSQL 17 for Windows ==="

          $PG_URL = "https://sbp.enterprisedb.com/getfile.jsp?fileid=1259911"
          $PG_DIR = "C:\pg-windows"

          New-Item -ItemType Directory -Force -Path $PG_DIR | Out-Null
          Set-Location $PG_DIR

          Write-Host "Downloading from: $PG_URL"
          Invoke-WebRequest -Uri $PG_URL -OutFile postgresql.zip

          Write-Host "Extracting..."
          Expand-Archive -Path postgresql.zip -DestinationPath .

          # Rename to consistent name
          if (Test-Path "pgsql") {
            Rename-Item "pgsql" "postgresql"
          }

          Write-Host "PostgreSQL installed at: $PG_DIR\postgresql"
          Get-ChildItem -Path postgresql
          Get-ChildItem -Path postgresql\bin | Select-Object -First 10

          # Verify pg_config exists
          if (Test-Path "postgresql\bin\pg_config.exe") {
            Write-Host "pg_config found!"
            & .\postgresql\bin\pg_config.exe --version
            & .\postgresql\bin\pg_config.exe --pgxs
          } else {
            Write-Error "pg_config.exe not found!"
            exit 1
          }

      - name: Setup Visual Studio Developer Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install GNU Make
        run: choco install make -y

      - name: Build pgvector with MSVC (Phase 1)
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set VERSION=${{ github.event.inputs.version }}
          set PGVECTOR_VERSION=0.8.0
          set PG_DIR=C:\pg-windows\postgresql
          set PG_CONFIG=%PG_DIR%\bin\pg_config.exe

          echo === Building pgvector v%PGVECTOR_VERSION% with MSVC ===
          echo PG_CONFIG: %PG_CONFIG%

          :: Get PGXS path
          for /f "tokens=*" %%i in ('"%PG_CONFIG%" --pgxs') do set PGXS=%%i
          echo PGXS: %PGXS%

          :: Clone pgvector
          mkdir C:\build 2>nul
          cd C:\build

          if not exist pgvector (
            git clone --depth 1 --branch v%PGVECTOR_VERSION% https://github.com/pgvector/pgvector.git
          )

          cd pgvector

          :: Show Makefile
          echo.
          echo === pgvector Makefile (first 30 lines) ===
          more +1 Makefile | findstr /n "^" | findstr "^[1-9]:" | findstr /v "^[3-9][0-9]:"

          echo.
          echo === Building with GNU Make and PGXS ===

          :: PGXS requires GNU Make (not nmake)
          :: GNU Make installed via chocolatey
          :: Add PostgreSQL include dir for libintl.h
          set CPPFLAGS=-I%PG_DIR%\include
          echo CPPFLAGS: %CPPFLAGS%

          make PG_CONFIG="%PG_CONFIG%" CPPFLAGS="%CPPFLAGS%"

          if errorlevel 1 (
            echo.
            echo === Build failed ===
            echo.
            echo Trying to show pg_config details...
            "%PG_CONFIG%" --cflags
            "%PG_CONFIG%" --ldflags
            "%PG_CONFIG%" --libs
            exit /b 1
          )

          echo.
          echo === Build succeeded! ===
          dir *.dll 2>nul || dir

      - name: Install and verify pgvector
        if: success()
        shell: cmd
        run: |
          @echo off
          set PG_DIR=C:\pg-windows\postgresql
          set PG_CONFIG=%PG_DIR%\bin\pg_config.exe

          cd C:\build\pgvector

          echo === Installing pgvector ===
          make PG_CONFIG="%PG_CONFIG%" install

          if errorlevel 1 (
            echo Install failed
            exit /b 1
          )

          echo.
          echo === Verifying installation ===

          :: Check extension files
          for /f "tokens=*" %%i in ('"%PG_CONFIG%" --sharedir') do set SHAREDIR=%%i
          for /f "tokens=*" %%i in ('"%PG_CONFIG%" --pkglibdir') do set PKGLIBDIR=%%i

          echo Share dir: %SHAREDIR%
          echo Lib dir: %PKGLIBDIR%

          echo.
          echo Extension control file:
          dir "%SHAREDIR%\extension\vector*" 2>nul || echo Not found

          echo.
          echo Extension library:
          dir "%PKGLIBDIR%\vector*" 2>nul || echo Not found

      - name: Create artifact
        if: success()
        shell: pwsh
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          $PHASE = "${{ github.event.inputs.phase }}"
          $PG_DIR = "C:\pg-windows\postgresql"

          Write-Host "=== Creating artifact ==="

          New-Item -ItemType Directory -Force -Path C:\output | Out-Null
          Set-Location C:\output

          # Copy PostgreSQL with installed extensions
          Copy-Item -Recurse -Path $PG_DIR -Destination .\postgresql-documentdb

          # Add metadata
          $metadata = @{
            name = "postgresql-documentdb"
            version = $VERSION
            platform = "win32-x64"
            phase = $PHASE
            source = "windows-build-debug"
            rehosted_by = "hostdb"
            rehosted_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          } | ConvertTo-Json

          $metadata | Out-File -FilePath ".\postgresql-documentdb\.hostdb-metadata.json" -Encoding utf8

          # Create zip
          $zipName = "postgresql-documentdb-$VERSION-win32-x64-$PHASE.zip"
          Compress-Archive -Path .\postgresql-documentdb -DestinationPath $zipName

          Write-Host ""
          Write-Host "=== Artifact created ==="
          Get-ChildItem *.zip

          # Calculate checksum
          $hash = Get-FileHash -Algorithm SHA256 $zipName
          "$($hash.Hash)  $zipName" | Out-File -FilePath checksums.txt -Encoding utf8
          Get-Content checksums.txt

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-documentdb-${{ github.event.inputs.version }}-win32-x64-${{ github.event.inputs.phase }}
          path: |
            C:/output/*.zip
            C:/output/checksums.txt
          retention-days: 7
